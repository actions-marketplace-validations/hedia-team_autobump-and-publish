name: "Hedia - NPM Autobumper"
description: "Hedia's npm packages autobumper"

inputs:
  github-token:
    description: "GitHub token used to remove comment from PR"
    required: true

  npm-token:
    description: "NPM token used to publish package to npm"
    required: true

  label:
    description: "Type of version bump [major, minor, patch]"
    required: true

  skip-step: # [true, false]
    description: "Variable used to determine if certain steps should be skipped"
    required: true

  issue-number:
    description: "Issue number required in order to write/remove comments on the current PR"
    required: true

  is-open-pr: # [true, false]
    description: "Variable used to determine if action is being triggered by oppening a PR"
    default: false

  is-post-merge: # [true, false]
    description: "Variable used to determine if action is being triggered by post-merging a PR"
    default: false

  run-ci: # [true, false]
    description: "Boolean value to determine if npm run ci shall run"
    required: false
    default: false

  run-lint: # [true, false]
    description: "Boolean value to determine if npm run lint shall run"
    required: false
    default: false

  run-lint-pkg: # [true, false]
    description: "Boolean value to determine if npm run lint-pkg shall run"
    required: false
    default: false

  run-test: # [true, false]
    description: "Boolean value to determine if npm run test shall run"
    required: false
    default: false

  run-test-coverage: # [true, false]
    description: "Boolean value to determine if npm run test-coverage shall run"
    required: false
    default: false

  run-tsc: # [true, false]
    description: "Boolean value to determine if npm run tsc shall run"
    required: false
    default: false

runs:
  using: "composite"

  steps:
    - name: Register NPM access token
      run: |
        if [[ "${{inputs.skip-step}}" == 'false' ]]; then
          echo "Registering NPM access token"
          npm config set '//registry.npmjs.org/:_authToken' "${NPM_TOKEN}"
        else
          echo "Skipped registering NPM access token"
        fi
        exit 0
      env:
        NPM_TOKEN: ${{ inputs.npm-token }}
      shell: bash

    - name: Fetch latest version from NPM
      id: bump-package-version
      run: |
        if [[ "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          echo "Fetching latest package version"
          chmod +x bump-package-version.sh
          ./bump-package-version.sh "$inputs.label"
        else
          echo "Skipped bumping version"
        fi
        exit 0
      shell: bash

    - name: Run ci
      id: run-ci
      run: |
        if [[ "${{inputs.run-ci}}" == 'true' && "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          echo "Running ci"
          npm run ci --ignore-scripts
        else
          echo "Skipped ci"
        fi
        exit 0
      shell: bash

    - name: Run lint
      id: run-lint
      run: |
        if [[ "${{inputs.run-lint}}" == 'true' && "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          echo "Running lint"
          npm run lint
        else
          echo "Skipped lint"
        fi
        exit 0
      shell: bash

    - name: Run lint-pkg
      id: run-lint-pkg
      run: |
        if [[ "${{inputs.run-lint-pkg}}" == 'true' && "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          echo "Running lint-pkg"
          npm run lint-pkg
        else
          echo "Skipped lint-pkg"
        fi
        exit 0
      shell: bash

    - name: Run test-coverage
      id: run-test-coverage
      run: |
        if [[ "${{inputs.run-test-coverage}}" == 'true' && "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          echo "Running test-coverage"
          npm run test-coverage
        else
          echo "Skipped test-coverage"
        fi
        exit 0
      shell: bash

    - name: Run test
      id: run-test
      run: |
        if [[ "${{inputs.run-test}}" == 'true' && "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          echo "Running test"
          npm run test
        else
          echo "Skipped test"
        fi
        exit 0
      shell: bash

    - name: Run tsc
      id: run-tsc
      run: |
        if [[ "${{inputs.run-tsc}}" == 'true' && "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          echo "Running tsc"
          npm run tsc
        else
          echo "Skipped tsc"
        fi
        exit 0
      shell: bash

    - name: Publish alpha version
      id: publish-alpha
      run: |
        if [[ "${{inputs.skip-step}}" == 'false' ]]; then
          echo "publishing alpha"
          npm publish --tag alpha
        elif [[ "${{inputs.is-post-merge}}" == 'true' ]]; then
          echo "publishing release"
          npm publish
        else
          echo "Skipped publishing"
        fi
        exit 0
      shell: bash

    - name: Remove alpha tag
      id: remove-alpha-tag
      run: |
        if [[ "${{inputs.skip-step}}" == 'false' && "${{inputs.is-post-merge}}" == 'false' ]]; then
          chmod +x ./remove-alpha-tag.sh && ./remove-alpha-tag.sh
        else
          echo "Skipped remove-alpha-tag"
        fi
        exit 0
      shell: bash

    - name: Remove old comment from PR
      id: delete-comment
      uses: izhangzhihao/delete-comment@master
      with:
        github_token: ${{ inputs.github-token }}
        delete_user_name: github-actions[bot]
        issue_number: ${{ inputs.issue-number }} # remove comments from the current PR

    - name: Write comment on PR
      id: write-comment
      uses: peter-evans/create-or-update-comment@v1
      with:
        issue-number: ${{ inputs.issue-number }}
        body: |
          ðŸŽ‰  Successfully published new version  ðŸŽ‰

branding:
  icon: "arrow-up-circle"
  color: "purple"
